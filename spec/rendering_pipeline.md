# 3DCGレンダリングパイプライン仕様書

このプログラムで実装されている3DCGの変換処理の流れを以下に示します。

## 変換パイプラインの流れ

### 1. ワールド座標変換（World Transform）
- **処理内容**: オブジェクトをワールド空間内の指定位置に配置
- **変換行列**: 平行移動行列（Translation Matrix）
- **詳細**: `LocatedObject` の X, Y, Z 座標を使用して、オブジェクトの各頂点を平行移動

### 2. カメラ座標変換（View Transform）
- **処理内容**: カメラを原点とする座標系に変換
- **変換行列**: 
  - 平行移動行列（カメラ位置の逆方向に移動）
  - 回転行列（カメラの向きの逆方向に回転）
- **詳細**: 
  - カメラの位置（`Camera.Location`）の逆方向に平行移動
  - カメラの向き（`Camera.Direction`）の逆方向に回転（Z→Y→X軸の順）

### 3. 透視投影変換（Perspective Projection）
- **処理内容**: 3D座標を2D画面座標に投影し、遠近感を表現

#### 3.1. クリッピング処理（Clipping）
- **アルゴリズム**: Sutherland-Hodgman アルゴリズム
- **処理内容**: 
  - ビューボリューム（視錐台）の外側にある部分を除去
  - 6つのクリッピング面（Near, Far, Left, Right, Bottom, Top）で順次クリッピング
  - 三角形の分割と再構成を実行

#### 3.2. 投影行列の適用
- **座標系**: 左手座標系
- **変換先**: NDC（Normalized Device Coordinates・正規化デバイス座標）
- **座標範囲**: x,y ∈ [-1,1], z ∈ [0,1]
- **投影行列**: 視野角（FieldOfView）、アスペクト比、Near/Far距離を考慮

#### 3.3. 透視除算（Perspective Division）
- **処理内容**: 同次座標のw成分で各座標を除算してNDCに変換

#### 3.4. 頂点マージ処理
- **処理内容**: 
  - 重複する頂点を統合（VertexGrid使用、epsilon = 1e-2）
  - 重複する辺と三角形を除去（CleanEdges, CleanTriangles）

### 4. ビューポート変換（Viewport Transform）
- **処理内容**: NDC座標を画面ピクセル座標に変換
- **座標系**: SDL2準拠
  - 原点(0,0)は左上
  - X軸は右方向が正
  - Y軸は下方向が正（上下反転処理を実行）
- **変換内容**:
  - 画面の半分のサイズでスケーリング
  - Y軸を反転（-harfHeight）
  - 画面中央に平行移動

### 5. 離散化処理（Discretization）
- **処理内容**: 浮動小数点座標を整数ピクセル座標に変換
- **変換方法**: `math.Round()` を使用して四捨五入

## 座標系の変遷

1. **ローカル座標系** → **ワールド座標系**（平行移動）
2. **ワールド座標系** → **カメラ座標系**（平行移動 + 回転）
3. **カメラ座標系** → **クリップ座標系**（透視投影行列）
4. **クリップ座標系** → **NDC座標系**（透視除算）
5. **NDC座標系** → **画面座標系**（ビューポート変換）
6. **画面座標系** → **ピクセル座標系**（離散化）

## 使用されている変換行列

- **平行移動行列**: 4x4同次座標行列
- **回転行列**: X軸、Y軸、Z軸回転行列の合成（Z→Y→X順）
- **透視投影行列**: 左手座標系用の透視投影行列
- **ビューポート行列**: スケーリング + 平行移動の合成

## 特徴的な実装

- **左手座標系**を採用
- **Sutherland-Hodgmanアルゴリズム**による高精度クリッピング
- **VertexGrid**による効率的な重複頂点管理
- **同次座標**を使用した統一的な変換処理
